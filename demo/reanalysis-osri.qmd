---
title: "Reanalysis OSRI"
format: html
editor: visual
---

# Data preparation

## Imports

```{r}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
rm(list = ls())
```

## Set seed

```{r}
set.seed(17092024)
```

## Loading the data

Data available on OSF: <https://osf.io/rvhsw>

```{r}
OSRI <- read.csv("../data/OSRI_osfDeRoover.csv", sep = ";")
```

```{r}
table(OSRI$orientation)
```

Total sample size matches what is reported in De Roover & Vermunt but group sizes not. Upon checking if their group sizes correspond to Q44 and Q1, appeared to be the latter (Q1).

## Data wrangling

Group by orientation and standardize per group. Note: 1= Heterosexual, 2 = Bisexual, 3 = Homosexual, 4 = Asexual, 5 = Other.

```{r}
matrix1 <- as.matrix(OSRI[OSRI$orientation == 1, 1:44])
matrix1 <- scale(matrix1, center = TRUE, scale = TRUE)
matrix2 <- as.matrix(OSRI[OSRI$orientation == 2, 1:44])
matrix2 <- scale(matrix2, center = TRUE, scale = TRUE)
matrix3 <- as.matrix(OSRI[OSRI$orientation == 3, 1:44])
matrix3 <- scale(matrix3, center = TRUE, scale = TRUE)
matrix4 <- as.matrix(OSRI[OSRI$orientation == 4, 1:44])
matrix4 <- scale(matrix4, center = TRUE, scale = TRUE)
matrix5 <- as.matrix(OSRI[OSRI$orientation == 5, 1:44])
matrix5 <- scale(matrix5, center = TRUE, scale = TRUE)

DATA <- list(matrix1, matrix2, matrix3, matrix4, matrix5)
G <- 5
```

Number of factors set in correspondence with literature:

```{r}
R <- 2
```

# Modelling

## Imports

```{r}
# load MASS
library(MASS)
```

```{r}
# load needed functions
source("../R/initial-loadings.R")
source("../R/multistart.R")
source("../R/pstr.R")
source("../R/joint-spca-finalizing.R")
source("../R/is-jspca.R")
source("../R/seqstrategy.R")
source("../R/performance-measures.R")
```

## Model selection

```{r}
model <- seqstrategy(DATA, R = R, SP = 0.9, ALPH = 0.1, THR = 0.05) # sequential strategy
```

Inspect results:

```{r}
model$details
model$cardinality
model$lambda
```

## Stabilize solution

```{r}
selmodel <- MULTISTART(DATA, R, CARD = model$cardinality, LAMBDA = model$lambda, SP = seq(0.1, 0.9, by = 0.1), ALPH = seq(0.1, 0.9, by = 0.1), MAXITER = 20, EPS = 1e-4)
L <- selmodel$loadings
Loadings <- round(cbind(L[[1]], L[[2]], L[[3]], L[[4]], L[[5]]), 2)
Loadings
```

Check that loadings \~= correlation:

```{r}
rbind(cor(selmodel$scores[[1]][, 1], matrix1), selmodel$loadings[[1]][, 1])
```

## Inspect results

Item-similarity of loadings over groups:

```{r}
concL1 <- c()
concL2 <- c()
for (g in 1:G) {
  concL1 <- cbind(concL1, L[[g]][, 1])
  concL2 <- cbind(concL2, L[[g]][, 2])
}
```

```{r}
concL1
concL2
```

Variability loadings over groups:

```{r}
round(sqrt(diag(var(t(concL1)))) + sqrt(diag(var(t(concL2)))), 3)
# 10 items:32, 12, 14, 25, 22, 20, 13, 21, 11, 38
```

Items that load 0 on both factors:

```{r}
index <- 1:44
index[rowSums(abs(cbind(concL1, concL2))) < 0.05]
# items 1 and 7
```

Items with cross loadings:

```{r}
index[abs(concL1) > 0.05 & abs(concL2) > 0.05]
# items 9,13,20,21,22,34
```

## Save results

Write model selection results to csv:

```{r}
write.table(model$details, file = "ReanalysisOSRIGeneratedFiles/OSRI_modelselection.txt", dec = ",", sep = "\t")
```

Write loadings to csv:

```{r}
write.table(Loadings, file = "ReanalysisOSRIGeneratedFiles/OSRI_loadings_RegMGEFA.txt", dec = ",", sep = "\t")
```

Save item-similarity of loadings over groups:

```{r}
save(concL1, file = "ReanalysisOSRIGeneratedFiles/OSRI_concl1.Rdata")
save(concL1, file = "ReanalysisOSRIGeneratedFiles/OSRI_concl2.Rdata")
```
